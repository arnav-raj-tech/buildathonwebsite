
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Student Budget Buddy - Track your expenses and manage pocket money smartly.">
<title>Expense Tracker | Student Budget Buddy</title>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { 
  getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import { 
  getFirestore, collection, addDoc, getDocs, doc, deleteDoc, setDoc, updateDoc, getDoc 
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

// ğŸ”¹ Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyDwmJ-6PWeD6x-5rjiWywsFMDlEFSSCsgc",
  authDomain: "student-budget-tracker-ac367.firebaseapp.com",
  projectId: "student-budget-tracker-ac367",
  storageBucket: "student-budget-tracker-ac367.appspot.com",
  messagingSenderId: "367537585165",
  appId: "1:367537585165:web:cb945c4d12cad3914ee944"
};

// ğŸ”¹ Initialize Firebase once
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ==================== AUTH SECTION ====================
async function authenticate(email, password) {
  try {
    await signInWithEmailAndPassword(auth, email, password);
    alert("Login successful!");
    document.getElementById("loginModal").style.display = "none";
    loadExpenses();
  } catch {
    try {
      await createUserWithEmailAndPassword(auth, email, password);
      alert("Account created successfully!");
      document.getElementById("loginModal").style.display = "none";
      loadExpenses();
    } catch (err) {
      alert(err.message);
    }
  }
}
window.authenticate = authenticate;

onAuthStateChanged(auth, user => {
  if (user) {
    document.getElementById("loginBtn").style.display = "none";
    document.getElementById("userEmail").innerText = user.email;
    loadExpenses();
    loadBudget();
  } else {
    document.getElementById("loginBtn").style.display = "inline-block";
    document.getElementById("userEmail").innerText = "";
    expenses = [];
    budget = 0;
    renderTable();
  }
});

// ==================== EXPENSE + BUDGET HANDLING ====================
let expenses = [];
let budget = 0;

// ğŸ”¸ Add Expense
window.addExpense = async function () {
  const user = auth.currentUser;
  if (!user) return alert("Login first!");

  const desc = document.getElementById("desc").value.trim();
  let category = document.getElementById("category").value;
  if (category === "Others") category = document.getElementById("otherCategory").value.trim() || "Others";
  const amount = parseFloat(document.getElementById("amount").value);
  const date = document.getElementById("date").value;

  if (!desc || !amount || !date) return alert("Please fill all fields!");

  try {
    await addDoc(collection(db, "expenses"), { uid: user.uid, desc, category, amount, date });
    alert("Expense added!");
    document.getElementById("desc").value = "";
    document.getElementById("amount").value = "";
    document.getElementById("date").value = "";
    document.getElementById("otherCategory").value = "";
    loadExpenses();
  } catch (err) {
    alert("Error adding expense: " + err.message);
  }
};

// ğŸ”¸ Load Expenses
window.loadExpenses = async function () {
  const user = auth.currentUser;
  if (!user) return;
  expenses = [];
  const snapshot = await getDocs(collection(db, "expenses"));
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    if (data.uid === user.uid) expenses.push({ ...data, id: docSnap.id });
  });
  renderTable();
};

// ğŸ”¸ Delete Expense
window.deleteExpense = async function (id) {
  if (confirm("Delete this expense?")) {
    await deleteDoc(doc(db, "expenses", id));
    loadExpenses();
  }
};

// ğŸ”¸ Edit Expense
window.editExpense = function (id) {
  const exp = expenses.find(e => e.id === id);
  if (!exp) return;
  document.getElementById("desc").value = exp.desc;
  document.getElementById("amount").value = exp.amount;
  document.getElementById("date").value = exp.date;

  if (["Food", "Transport", "Books", "Leisure"].includes(exp.category)) {
    document.getElementById("category").value = exp.category;
    document.getElementById("otherCategory").style.display = "none";
  } else {
    document.getElementById("category").value = "Others";
    document.getElementById("otherCategory").style.display = "block";
    document.getElementById("otherCategory").value = exp.category;
  }

  deleteExpense(id);
};

// ğŸ”¸ Render Table
function renderTable() {
  const tbody = document.querySelector("#expenseTable tbody");
  tbody.innerHTML = "";
  let total = 0;
  expenses.forEach(e => {
    total += e.amount;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${e.desc}</td>
      <td>${e.category}</td>
      <td>â‚¹${e.amount.toFixed(2)}</td>
      <td>${e.date}</td>
      <td>
        <button class="edit-btn" onclick="editExpense('${e.id}')">Edit</button>
        <button class="delete-btn" onclick="deleteExpense('${e.id}')">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
  document.getElementById("total").innerText = total.toFixed(2);

  if (budget > 0 && total > budget) {
    document.getElementById("budget-warning").style.display = "block";
    document.getElementById("budget-warning").innerText = "âš ï¸ You have exceeded your budget!";
  } else {
    document.getElementById("budget-warning").style.display = "none";
  }

  updateChart();
}

// ğŸ”¸ Set Budget
window.setBudgetHandler = async function () {
  const user = auth.currentUser;
  if (!user) return alert("Login first!");
  const val = parseFloat(document.getElementById("budget").value);
  if (isNaN(val) || val <= 0) return alert("Invalid budget!");

  await setDoc(doc(db, "budgets", user.uid), { value: val });
  budget = val;
  alert("Budget set to â‚¹" + budget);
  renderTable();
};

// ğŸ”¸ Load Budget
async function loadBudget() {
  const user = auth.currentUser;
  if (!user) return;
  const docSnap = await getDoc(doc(db, "budgets", user.uid));
  if (docSnap.exists()) budget = docSnap.data().value;
}

// ğŸ”¸ Search + Sort
window.searchExpenses = function () {
  const term = document.getElementById("search").value.trim().toLowerCase();
  const tbody = document.querySelector("#expenseTable tbody");
  tbody.innerHTML = "";
  let total = 0;
  expenses
    .filter(e => e.desc.toLowerCase().includes(term) || e.category.toLowerCase().includes(term))
    .forEach(e => {
      total += e.amount;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${e.desc}</td>
        <td>${e.category}</td>
        <td>â‚¹${e.amount.toFixed(2)}</td>
        <td>${e.date}</td>
        <td>
          <button class="edit-btn" onclick="editExpense('${e.id}')">Edit</button>
          <button class="delete-btn" onclick="deleteExpense('${e.id}')">Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
  document.getElementById("total").innerText = total.toFixed(2);
};

window.sortTable = function (n) {
  const tbody = document.querySelector("#expenseTable tbody");
  const rows = Array.from(tbody.rows);
  let asc = tbody.getAttribute("data-sort-dir") !== "asc";
  rows.sort((a, b) => {
    let x = a.cells[n].innerText.toLowerCase(),
      y = b.cells[n].innerText.toLowerCase();
    if (n === 2) {
      x = parseFloat(x.replace("â‚¹", ""));
      y = parseFloat(y.replace("â‚¹", ""));
    }
    return (x < y ? -1 : 1) * (asc ? 1 : -1);
  });
  tbody.innerHTML = "";
  rows.forEach(r => tbody.appendChild(r));
  tbody.setAttribute("data-sort-dir", asc ? "asc" : "desc");
};

// ==================== CHART + AI ====================
let chart;
function updateChart() {
  const catTotals = {};
  expenses.forEach(e => {
    catTotals[e.category] = (catTotals[e.category] || 0) + e.amount;
  });
  const labels = Object.keys(catTotals);
  const data = Object.values(catTotals);
  const ctx = document.getElementById("expenseChart").getContext("2d");
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: "pie",
    data: { labels, datasets: [{ data, backgroundColor: ["#4caf50", "#00a651", "#8bc34a", "#c8e6c9", "#aed581"] }] },
    options: { plugins: { legend: { position: "bottom" } } }
  });
}

// ğŸ”¸ Expense AI Chatbot
const aiResponses = {
  food: ["ğŸ” Meal prep saves money!", "ğŸ¥— Try home-cooked meals.", "â˜• Avoid takeaways!"],
  transport: ["ğŸšŒ Use student passes.", "ğŸš´ Walk or bike.", "ğŸš— Carpool saves cash."],
  books: ["ğŸ“š Use library first.", "ğŸ’¡ Buy second-hand books.", "ğŸ“ Rent textbooks."],
  leisure: ["ğŸ¬ Limit streaming.", "ğŸ® Try free hobbies.", "ğŸ§© Plan leisure spends."],
  others: ["ğŸ’­ Review misc costs.", "ğŸ’¸ Track carefully.", "ğŸ“Š Small spends add up."]
};

function appendMessage(sender, message) {
  const log = document.getElementById("ai-chat-log");
  const div = document.createElement("div");
  div.style.marginBottom = "6px";
  div.innerHTML = `<strong>${sender}:</strong> ${message}`;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

window.askExpenseAI = function () {
  const input = document.getElementById("ai-chat-input");
  const query = input.value.trim().toLowerCase();
  if (!query) return;
  appendMessage("You", input.value);
  input.value = "";

  let response = "ğŸ¤– I didnâ€™t understand. Ask about food, transport, books, leisure, others, or budget.";

  if (query.includes("budget") || query.includes("50/30/20") || query.includes("save")) {
    const totalBudget = parseFloat(prompt("Enter your monthly budget â‚¹:"));
    if (!isNaN(totalBudget) && totalBudget > 0) {
      const needs = (totalBudget * 0.5).toFixed(2);
      const wants = (totalBudget * 0.3).toFixed(2);
      const savings = (totalBudget * 0.2).toFixed(2);
      response = `ğŸ¤– For â‚¹${totalBudget}, 50/30/20 rule â†’ ğŸ  Needs: â‚¹${needs}, ğŸ‰ Wants: â‚¹${wants}, ğŸ’° Savings: â‚¹${savings}`;
    } else response = "ğŸ¤– Invalid amount!";
  } else if (query.includes("food")) response = "ğŸ¤– " + aiResponses.food[Math.floor(Math.random() * aiResponses.food.length)];
  else if (query.includes("transport")) response = "ğŸ¤– " + aiResponses.transport[Math.floor(Math.random() * aiResponses.transport.length)];
  else if (query.includes("book")) response = "ğŸ¤– " + aiResponses.books[Math.floor(Math.random() * aiResponses.books.length)];
  else if (query.includes("leisure") || query.includes("fun")) response = "ğŸ¤– " + aiResponses.leisure[Math.floor(Math.random() * aiResponses.leisure.length)];
  else if (query.includes("other")) response = "ğŸ¤– " + aiResponses.others[Math.floor(Math.random() * aiResponses.others.length)];

  appendMessage("Expense AI", response);
};
</script>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<footer>
2025 Student Budget Buddy | Made for students ğŸ’¸ Contact us at studentbudgetbuddyhelp@gmail.com
</footer>
</body>
</html>

