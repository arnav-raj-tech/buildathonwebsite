<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="A comprehensive student expense tracker with smart tips, warnings, and budget analytics.">
<title>Expense Tracker | Student Budget Buddy</title>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDwmJ-6PWeD6x-5rjiWywsFMDlEFSSCsgc",
    authDomain: "student-budget-tracker-ac367.firebaseapp.com",
    projectId: "student-budget-tracker-ac367",
    storageBucket: "student-budget-tracker-ac367.appspot.com",
    messagingSenderId: "367537585165",
    appId: "1:367537585165:web:cb945c4d12cad3914ee944"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let expenses = [];
  let budget = 0;
  let currentUser = null;

  // Authentication
  async function login() {
    const email = prompt("Enter your email:");
    const password = prompt("Enter your password:");
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (err) {
      if (err.code === "auth/user-not-found") {
        const create = confirm("User not found. Create a new account?");
        if (create) {
          await createUserWithEmailAndPassword(auth, email, password);
        }
      } else {
        alert(err.message);
      }
    }
  }

  onAuthStateChanged(auth, async user => {
    if (user) {
      currentUser = user;
      document.getElementById("auth-status").innerText = `Logged in as: ${user.email}`;
      await loadData();
    } else {
      currentUser = null;
      document.getElementById("auth-status").innerText = "Not logged in";
    }
  });

  async function loadData() {
    if (!currentUser) return;
    const docRef = doc(db, "users", currentUser.uid);
    const docSnap = await getDoc(docRef);
    if (docSnap.exists()) {
      const data = docSnap.data();
      expenses = data.expenses || [];
      budget = data.budget || 0;
      document.getElementById("budget").value = budget;
      renderTable();
    } else {
      await setDoc(docRef, { expenses: [], budget: 0 });
    }
  }

  async function saveData() {
    if (!currentUser) return;
    await setDoc(doc(db, "users", currentUser.uid), { expenses, budget });
  }

  window.login = login;
</script>

<style>
body {
    font-family: 'Poppins', sans-serif;
    margin:0;
    background: linear-gradient(135deg, #d2f7d2, #a0e9a0);
    color: #333;
    transition: all 0.3s ease;
}
header{
    background: #00a651;
    color: white;
    text-align:center;
    padding:20px 10px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
}
nav{
    background: #007f3f;
    display:flex;
    flex-wrap: wrap;
    justify-content:center;
    gap:15px;
    padding:10px;
}
nav a{
    color:white;
    text-decoration:none;
    padding:8px 12px;
    border-radius:5px;
    transition: all 0.3s ease;
    text-align:center;
}
nav a:hover{
    background: rgba(255,255,255,0.2);
}
.container{
    max-width:900px;
    margin:20px auto;
    background:white;
    padding:20px;
    border-radius:12px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    animation: fadeIn 0.5s ease;
}
input, select, button{
    padding:10px;
    border-radius:6px;
    border:1px solid #ccc;
    margin-top:10px;
    transition: all 0.3s ease;
    width: 100%;
    max-width: 250px;
    display:block;
}
button{
    background:#00a651;
    color:white;
    border:none;
    cursor:pointer;
    margin-top:10px;
}
button:hover{
    background:#007f3f;
}
table{
    width:100%;
    border-collapse: collapse;
    margin-top:20px;
    overflow-x:auto;
    display:block;
}
th, td{
    padding:10px;
    border-bottom:1px solid #ddd;
    text-align:center;
}
th{
    background:#c4f0c4;
    cursor:pointer;
}
tr:hover{
    background:#e5ffe5;
}
.delete-btn, .edit-btn{
    padding:6px 10px;
    border:none;
    border-radius:5px;
    cursor:pointer;
    color:white;
}
.edit-btn{
    background:#4caf50;
}
.edit-btn:hover{background:#388e3c;}
.delete-btn{
    background:#f44336;
}
.delete-btn:hover{background:#c62828;}
.summary{
    margin-top:15px;
    font-weight:bold;
    text-align:right;
}
.budget-warning{
    color:red;
    font-size:1.1em;
    margin-top:10px;
    display:none;
}
.chart-container{
    margin-top:20px;
    max-width: 100%;
}
.video-container{
    position:relative;
    padding-bottom:56.25%;
    height:0;
    overflow:hidden;
    border-radius:12px;
    margin:20px auto;
    max-width:800px;
    box-shadow:0 4px 12px rgba(0,0,0,0.2);
}
.video-container iframe{
    position:absolute;
    top:0;
    left:0;
    width:100%;
    height:100%;
    border:0;
}
.tip-popup{
    position:fixed;
    bottom:20px;
    left:50%;
    transform:translateX(-50%);
    background:#fff;
    border-radius:12px;
    padding:12px 20px;
    box-shadow:0 5px 15px rgba(0,0,0,0.3);
    display:flex;
    align-items:center;
    gap:10px;
    font-weight:500;
    z-index:9999;
    animation: slideUp 0.5s ease;
}
#auth-status{
    margin-bottom:15px;
    font-weight:bold;
}
@keyframes fadeIn{from{opacity:0;} to{opacity:1;}}
@keyframes slideUp{from{transform:translateY(20px) translateX(-50%); opacity:0;} to{transform:translateY(0) translateX(-50%); opacity:1;}}
@media(max-width:600px){
    header h1{font-size:1.5em;}
    nav a{font-size:0.9em;padding:6px 8px;}
    .container{padding:15px;margin:15px;}
    table, th, td{font-size:0.85em;}
}
</style>
</head>
<body>
<header>
<h1>Expense Tracker</h1>
<div id="auth-status">Not logged in</div>
<button onclick="login()">Login / Create Account</button>
</header>
<nav>
<a href="index.html">Home</a>
<a href="tracker.html">Expense Tracker</a>
<a href="tips.html">Money Tips</a>
<a href="https://docs.google.com/forms/d/e/1FAIpQLSe0FppmFElsTpw5sPLd8CNJCxoPkCAnOKgH46ebzdR1NTwIgg/viewform">Feedback</a>
<a href="about.html">About Us</a>
</nav>

<div class="container">
<h2>Add a New Expense</h2>
<input type="text" id="desc" placeholder="Description">
<input type="number" id="amount" placeholder="Amount ‚Çπ" min="0" step="0.01">
<select id="category" onchange="checkOthers(this.value)">
    <option value="Food">Food</option>
    <option value="Transport">Transport</option>
    <option value="Books">Books</option>
    <option value="Leisure">Leisure</option>
    <option value="Others">Others</option>
</select>
<input type="text" id="otherCategory" placeholder="Specify if Others" style="display:none;">
<input type="date" id="date">
<button onclick="addExpense()">Add Expense</button>

<h3>Expense List</h3>
<input type="text" id="search" placeholder="Search expenses...">
<button onclick="searchExpenses()">Search</button>

<table id="expenseTable">
<thead>
<tr>
<th onclick="sortTable(0)">Description</th>
<th onclick="sortTable(1)">Category</th>
<th onclick="sortTable(2)">Amount</th>
<th onclick="sortTable(3)">Date</th>
<th>Action</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div class="summary">
Total Spent: ‚Çπ<span id="total">0</span>
<span id="budget-status"></span>
</div>
<div class="budget-warning" id="budget-warning"></div>

<h3>Budget Settings</h3>
<input type="number" id="budget" placeholder="Set Monthly Budget ‚Çπ">
<button onclick="setBudget()">Set Budget</button>

<h3>Expense Breakdown</h3>
<div class="chart-container">
<canvas id="expenseChart"></canvas>
</div>

<div class="video-container">
<iframe src="https://www.youtube.com/embed/MXCvtC0HqLE?start=478&autoplay=0" title="Money Management for Students" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div>
</div>

<script type="module">
import { doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

function checkOthers(val){
    const otherInput = document.getElementById("otherCategory");
    otherInput.style.display = val==="Others" ? "inline-block":"none";
    if(val==="Others") otherInput.focus();
}

async function addExpense(){
    const desc = document.getElementById("desc").value.trim();
    const amount = parseFloat(document.getElementById("amount").value);
    let category = document.getElementById("category").value;
    const otherCat = document.getElementById("otherCategory").value.trim();
    if(category==="Others" && otherCat) category=otherCat;
    const date = document.getElementById("date").value || new Date().toISOString().split('T')[0];
    if(!desc || isNaN(amount) || amount<=0){ alert("Enter valid description and positive amount!"); return;}
    expenses.push({desc, amount, category, date});
    await saveData();
    renderTable();
    clearForm();
}

function clearForm(){
    document.getElementById("desc").value="";
    document.getElementById("amount").value="";
    document.getElementById("category").value="Food";
    document.getElementById("otherCategory").value="";
    document.getElementById("otherCategory").style.display="none";
    document.getElementById("date").value="";
}

async function setBudget(){
    budget=parseFloat(document.getElementById("budget").value);
    await saveData();
    checkBudget(parseFloat(document.getElementById("total").innerText));
}

function checkBudget(total){
    const warning = document.getElementById("budget-warning");
    const status = document.getElementById("budget-status");
    if(budget>0 && total>budget){
        warning.style.display="block";
        warning.innerText="‚ö†Ô∏è Budget Exceeded! Please cut down! This might affect your finances badly, but you can still continue using the tracker.";
        status.innerText=` (Budget: ‚Çπ${budget})`;
    }
    else{
        warning.style.display="none";
        status.innerText=` (Budget: ‚Çπ${budget})`;
    }
}

let chartInstance=null;
function renderChart(catTotals){
    const ctx=document.getElementById("expenseChart").getContext("2d");
    if(chartInstance) chartInstance.destroy();
    chartInstance=new Chart(ctx,{
        type:'pie',
        data:{
            labels:Object.keys(catTotals),
            datasets:[{
                data:Object.values(catTotals),
                backgroundColor:['#a5d6a7','#66bb6a','#388e3c','#00c853','#b9f6ca','#00e676','#1b5e20']
            }]
        }
    });
}

function showTip(message){
    const popup=document.createElement("div");
    popup.className="tip-popup";
    popup.innerHTML=`<i class="fas fa-lightbulb" style="color:#ffc107;"></i> ${message}`;
    document.body.appendChild(popup);
    setTimeout(()=>{ popup.remove(); },5000);
}

function smartTips(total, catTotals){
    if((catTotals['Food']||0)/total*100>40) showTip("üçî Food is taking over your budget! Consider cheaper meals.");
    if(budget>0 && total>budget*0.9) showTip("‚ö†Ô∏è You're close to your monthly budget! Track carefully.");
    Object.keys(catTotals).forEach(cat=>{
        if(!['Food','Transport','Books','Leisure'].includes(cat)){
            if(catTotals[cat]/total*100>30) showTip(`üí° ${cat} is taking over your budget! Consider saving money.`);
        }
    });
}

function renderTable(){
    const tbody = document.querySelector("#expenseTable tbody");
    tbody.innerHTML="";
    let total=0;
    const catTotals={};

    expenses.forEach((item,index)=>{
        total+=parseFloat(item.amount);
        catTotals[item.category]= (catTotals[item.category] || 0)+parseFloat(item.amount);
        tbody.innerHTML+=`<tr>
        <td>${item.desc}</td>
        <td>${item.category}</td>
        <td>‚Çπ${item.amount.toFixed(2)}</td>
        <td>${item.date}</td>
        <td>
            <button class="edit-btn" onclick="editExpense(${index})">Edit</button>
            <button class="delete-btn" onclick="deleteExpense(${index})">Delete</button>
        </td>
        </tr>`;
    });

    document.getElementById("total").innerText=total.toFixed(2);
    checkBudget(total);
    renderChart(catTotals);
    smartTips(total,catTotals);
}

async function deleteExpense(index){ expenses.splice(index,1); await saveData(); renderTable(); }

async function editExpense(index){
    const newDesc = prompt("Edit Description:", expenses[index].desc);
    const newAmount = prompt("Edit Amount:", expenses[index].amount);
    const newCategory = prompt("Edit Category:", expenses[index].category);
    const newDate = prompt("Edit Date (YYYY-MM-DD):", expenses[index].date);
    if(newDesc && !isNaN(newAmount) && newAmount>0 && newCategory && newDate){
        expenses[index]={desc:newDesc, amount:parseFloat(newAmount), category:newCategory, date:newDate};
        await saveData(); renderTable();
    } else alert("Invalid input!");
}

function sortTable(col){
    expenses.sort((a,b)=>{
        if(col===2) return a.amount-b.amount;
        if(col===3) return new Date(a.date)-new Date(b.date);
        const keys=["desc","category"];
        return a[keys[col]]>b[keys[col]]?1:-1;
    });
    renderTable();
}

function searchExpenses(){
    const query=document.getElementById("search").value.toLowerCase();
    const filtered=expenses.filter(exp=>exp.desc.toLowerCase().includes(query) || exp.category.toLowerCase().includes(query));
    renderFilteredTable(filtered);
}

function renderFilteredTable(filtered){
    const tbody = document.querySelector("#expenseTable tbody");
    tbody.innerHTML="";
    filtered.forEach(item=>{
        const index=expenses.indexOf(item);
        tbody.innerHTML+=`<tr>
        <td>${item.desc}</td>
        <td>${item.category}</td>
        <td>‚Çπ${item.amount.toFixed(2)}</td>
        <td>${item.date}</td>
        <td>
            <button class="edit-btn" onclick="editExpense(${index})">Edit</button>
            <button class="delete-btn" onclick="deleteExpense(${index})">Delete</button>
        </td>
        </tr>`;
    });
}

renderTable();
</script>

<footer>
Student Budget Buddy Contact us at studentbudgetbuddyhelp@gmail.com
</footer>
</body>
</html>
